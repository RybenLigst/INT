---
- name: Deploy TeachUA Backend Service
  hosts: gcp_group_instance_back_group
  become: yes
  vars:
    backend_jar: "./build/backend/target/dev.war"
    backend_dest: "/opt/teachua-backend"
    backend_url: "http://34.121.241.173:8080"
    frontend_url: "http://34.132.63.67"
    
  tasks:
    - name: Install Java 17
      apt:
        name: openjdk-17-jdk
        state: present
        update_cache: yes

    - name: Stop existing spring-boot service
      systemd:
        name: spring-boot
        state: stopped
      ignore_errors: yes

    - name: Create backend directory
      file:
        path: "{{ backend_dest }}"
        state: directory
        owner: root
        group: root
        mode: '0755'

    - name: Create uploads directory
      file:
        path: "{{ backend_dest }}/uploads"
        state: directory
        owner: root
        group: root
        mode: '0755'

    - name: Copy backend JAR to server
      copy:
        src: "{{ backend_jar }}"
        dest: "{{ backend_dest }}/app.war"
        owner: root
        group: root
        mode: '0644'

    - name: Create Google Service Account JSON credentials file
      copy:
        content: |
          {
            "type": "service_account",
            "project_id": "{{ lookup('env', 'GOOGLE_CLOUD_PROJECT') | default('YOUR_PROJECT_ID') }}",
            "private_key_id": "{{ lookup('env', 'GOOGLE_PRIVATE_KEY_ID') | default('YOUR_PRIVATE_KEY_ID') }}",
            "private_key": "{{ lookup('env', 'SERVICE_ACCOUNT_PRIVATE_KEY') | default('YOUR_PRIVATE_KEY_HERE') }}",
            "client_email": "{{ lookup('env', 'SERVICE_ACCOUNT_CLIENT_EMAIL') | default('YOUR_SERVICE_ACCOUNT_EMAIL') }}",
            "client_id": "{{ lookup('env', 'GOOGLE_CLIENT_ID') | default('YOUR_CLIENT_ID') }}",
            "auth_uri": "https://accounts.google.com/o/oauth2/auth",
            "token_uri": "https://oauth2.googleapis.com/token",
            "auth_provider_x509_cert_url": "https://www.googleapis.com/oauth2/v1/certs",
            "client_x509_cert_url": "{{ lookup('env', 'GOOGLE_CERT_URL') | default('YOUR_CERT_URL') }}"
          }
        dest: "{{ backend_dest }}/google-service-account.json"
        mode: '0600'

    - name: Configure systemd service for Spring Boot
      copy:
        content: |
          [Unit]
          Description=TeachUA Backend Service
          After=network.target

          [Service]
          Type=simple
          User=root
          ExecStart=/usr/bin/java -Dspring.profiles.active=docker -jar {{ backend_dest }}/app.war
          Restart=on-failure
          RestartSec=30
          WorkingDirectory={{ backend_dest }}
          StandardOutput=journal
          StandardError=journal
          
          # Basic configuration
          Environment=JAVA_HOME=/usr/lib/jvm/java-17-openjdk-amd64
          Environment=BASE_URL={{ backend_url }}
          Environment=PUBLIC_URL=
          Environment=STATIC_FOLDER=/frontend
          Environment=UPLOAD_PATH={{ backend_dest }}/uploads
          Environment=URL_LOGS=/var/log/teachua
          
          # Database configuration
          Environment=DEV2_DATASOURCE_URL=jdbc:postgresql://34.173.19.35:5432/teachua
          Environment=DEV2_DATASOURCE_USER=teachua_user
          Environment=DEV2_DATASOURCE_PASSWORD=${DEV2_DATASOURCE_PASSWORD:-YOUR_DB_PASSWORD_HERE}
          
          # JWT configuration
          Environment=JWT_ACCESS_SECRET_KEY=${JWT_ACCESS_SECRET_KEY:-YOUR_JWT_ACCESS_SECRET_KEY_HERE}
          Environment=JWT_REFRESH_SECRET_KEY=${JWT_REFRESH_SECRET_KEY:-YOUR_JWT_REFRESH_SECRET_KEY_HERE}
          
          # Mail configuration
          Environment=USER_EMAIL=${USER_EMAIL:-YOUR_EMAIL_HERE}
          Environment=SEND_PASSWORD=${SEND_PASSWORD:-YOUR_SEND_PASSWORD_HERE}
          
          # OAuth2 configuration (from setenv.sh)
          Environment=OAUTH2_GOOGLE_CLIENT_ID=${OAUTH2_GOOGLE_CLIENT_ID:-YOUR_GOOGLE_CLIENT_ID_HERE}
          Environment=OAUTH2_GOOGLE_CLIENT_SECRET=${OAUTH2_GOOGLE_CLIENT_SECRET:-YOUR_GOOGLE_CLIENT_SECRET_HERE}
          Environment=OAUTH2_FACEBOOK_CLIENT_ID=${OAUTH2_FACEBOOK_CLIENT_ID:-YOUR_FACEBOOK_CLIENT_ID_HERE}
          Environment=OAUTH2_FACEBOOK_CLIENT_SECRET=${OAUTH2_FACEBOOK_CLIENT_SECRET:-YOUR_FACEBOOK_CLIENT_SECRET_HERE}
          
          # Google Service Account configuration
          Environment=GOOGLE_APPLICATION_CREDENTIALS={{ backend_dest }}/google-service-account.json
          Environment=SERVICE_ACCOUNT_CLIENT_EMAIL=${SERVICE_ACCOUNT_CLIENT_EMAIL:-YOUR_SERVICE_ACCOUNT_EMAIL}
          
          # Production configuration
          Environment=PROD_BASE_URL={{ backend_url }}
          Environment=GOOGLE_MAP_KEY=AIzaSyArEeghQZQaaV2miDz4V3Lo2wCuCtY9klA

          [Install]
          WantedBy=multi-user.target
        dest: /etc/systemd/system/spring-boot.service

    - name: Create application log directory
      file:
        path: /var/log/teachua
        state: directory
        owner: root
        group: root
        mode: '0755'

    - name: Reload systemd daemon
      systemd:
        daemon_reload: yes

    - name: Enable and start backend service
      systemd:
        name: spring-boot
        enabled: yes
        state: started

    - name: Wait for backend service startup
      wait_for:
        port: 8080
        host: localhost
        delay: 60
        timeout: 300
      register: port_check
      ignore_errors: yes

    - name: Check service status
      systemd:
        name: spring-boot
      register: service_status
      
    - name: Display service information
      debug:
        msg: 
          - "Service active: {{ service_status.status.ActiveState }}"
          - "Service sub-state: {{ service_status.status.SubState }}"
          - "Port 8080 status: {{ 'OPEN' if port_check is succeeded else 'CLOSED' }}"
      
    - name: Retrieve recent service logs
      shell: "journalctl -u spring-boot -n 100 --no-pager | tail -50"
      register: backend_logs
      
    - name: Display service logs
      debug:
        msg: "{{ backend_logs.stdout_lines | default([]) }}"
        
    - name: Test backend API endpoints
      uri:
        url: "{{ item }}"
        method: GET
        status_code: [200, 404, 302, 403, 401, 503]
        validate_certs: no
        timeout: 10
      register: api_checks
      with_items:
        - "http://localhost:8080/"
        - "http://localhost:8080/api/clubs"
        - "http://localhost:8080/swagger-ui/index.html"
        - "http://localhost:8080/actuator/health"
      ignore_errors: yes
      
    - name: Display API endpoint test results
      debug:
        msg: "API endpoint {{ item.url }}: {{ item.status | default('Failed') }}"
      loop: "{{ api_checks.results }}"
      when: api_checks is defined

    - name: Display deployment summary
      debug:
        msg: 
          - "Backend deployment process completed"
          - "Backend URL: {{ backend_url }}"
          - "Swagger UI: {{ backend_url }}/swagger-ui/index.html"
          - "Health Check: {{ backend_url }}/actuator/health"
      when: port_check is succeeded 